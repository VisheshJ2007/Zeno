<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#E7F4FF] font-sans">
  <div class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-[#0B1736] text-white flex flex-col justify-between">
      <div>
        <!-- Profile -->
        <div class="flex items-center space-x-3 p-4 border-b border-gray-700">
          <div class="w-10 h-10 bg-gray-600 rounded-full"></div>
          <div>
            <p class="font-semibold text-sm">Juliana Silva</p>
            <p class="text-xs text-gray-400">@julianasilva</p>
          </div>
        </div>

        <!-- Sidebar Navigation -->
        <nav class="flex flex-col space-y-1 mt-4 px-3">
          <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-[#1C2A4A]">
            <img src="dashboard-icon.png" alt="Dashboard" class="w-5 h-5">
            <span>Dashboard</span>
          </a>
          <a href="#" class="flex items-center space-x-3 bg-[#1C2A4A] px-3 py-2 rounded-lg">
            <img src="sessions-icon.png" alt="Sessions" class="w-5 h-5">
            <span>Sessions</span>
          </a>
          <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-[#1C2A4A]">
            <img src="progress-icon.png" alt="Progress" class="w-5 h-5">
            <span>Progress</span>
          </a>
          <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-[#1C2A4A]">
            <img src="practice-icon.png" alt="Practice" class="w-5 h-5">
            <span>Practice</span>
          </a>
          <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-[#1C2A4A]">
            <img src="review-icon.png" alt="Review" class="w-5 h-5">
            <span>Review</span>
          </a>
          <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-[#1C2A4A]">
            <img src="user-icon.png" alt="User" class="w-5 h-5">
            <span>User</span>
          </a>
        </nav>
      </div>

      <!-- Bottom Section -->
      <div class="p-4 space-y-2 text-sm text-gray-300 border-t border-gray-700">
        <a href="#" class="flex items-center space-x-2 hover:text-white">
          <img src="settings-icon.png" alt="Settings" class="w-4 h-4">
          <span>Setting</span>
        </a>
        <a href="#" class="flex items-center space-x-2 hover:text-white">
          <img src="logout-icon.png" alt="Logout" class="w-4 h-4">
          <span>Log Out</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-semibold text-gray-800">Study Dashboard</h1>
        <div class="flex items-center space-x-3">
          <input type="text" placeholder="Search..." class="px-3 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <img src="zeno-logo.png" alt="Zeno Logo" class="w-8 h-8">
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex space-x-3 mb-6">
        <button class="px-4 py-2 bg-[#0B1736] text-white rounded-full">Current</button>
        <button class="px-4 py-2 bg-white border rounded-full text-gray-700">Pending</button>
        <button class="px-4 py-2 bg-white border rounded-full text-gray-700">Completed</button>
      </div>

      <!-- Top Section: Progress + Key Topics -->
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <!-- Progress -->
        <div class="bg-white rounded-2xl p-6 shadow">
          <div class="flex justify-between items-center">
            <h2 class="font-semibold text-gray-700">PROGRESS</h2>
            <span class="text-sm text-gray-500">5-DAY STREAK</span>
          </div>
          <div class="flex items-center space-x-4 mt-4">
            <span id="currentValue" class="w-10 h-10 flex items-center justify-center bg-[#0B1736] text-white rounded-full">18</span>
            <div class="flex-1 bg-gray-200 rounded-full h-4 relative">
              <div id="progressBar" class="bg-[#0B1736] h-4 rounded-full transition-all duration-500" style="width: 94%;"></div>
            </div>
            <span id="goalValue" class="w-10 h-10 flex items-center justify-center bg-[#0B1736] text-white rounded-full">19</span>
          </div>
          <p class="mt-3 text-gray-600 text-sm">Total XP: ###</p>
        </div>

        <!-- Key Topics -->
        <div class="bg-white rounded-2xl p-6 shadow">
          <h2 class="font-semibold text-gray-700">KEY TOPICS</h2>
          <ul class="list-disc list-inside mt-3 text-gray-600">
            <li>Bullet 1</li>
            <li>Bullet 2</li>
          </ul>
        </div>
      </div>

      <!-- Upload Files + Create Study Plan -->
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <!-- Upload Files -->
        <div class="bg-white rounded-2xl p-6 shadow flex flex-col items-center justify-center text-center">
          <h2 class="font-semibold text-gray-700 mb-4">UPLOAD FILES</h2>
          <div class="border-2 border-dashed border-gray-400 rounded-full w-24 h-24 flex items-center justify-center mb-4">
            <img src="upload-icon.png" alt="Upload" class="w-8 h-8">
          </div>
          <button id="viewUploadsBtn" class="bg-[#0B1736] text-white px-6 py-2 rounded-full">View Uploaded Files</button>
          <!-- Uploaded transcriptions list (hidden until requested) -->
          <div id="transcriptionsSection" class="mt-4 w-full hidden">
            <h3 class="font-semibold text-gray-700 mb-2">Your Uploads</h3>
            <div id="transcriptionsList" class="space-y-3 text-sm text-gray-700"></div>
            <p id="transcriptionsMsg" class="text-xs text-gray-500 mt-2"></p>
          </div>
        </div>

        <!-- Create Study Plan -->
        <div class="bg-white rounded-2xl p-6 shadow">
          <h2 class="font-semibold text-gray-700 mb-3">CREATE STUDY PLAN</h2>
          <form id="planForm" class="flex flex-col gap-3">
            <input id="topic" class="border rounded px-3 py-2" placeholder="Topic (e.g., Derivatives)" required>
            <input id="notes" class="border rounded px-3 py-2" placeholder="Notes (optional)">
            <button class="bg-[#0B1736] text-white px-4 py-2 rounded">Add</button>
          </form>
          <p id="planMsg" class="text-sm text-gray-500 mt-2"></p>
        </div>
      </div>

      <!-- Your Plans -->
      <div class="bg-white rounded-2xl p-6 shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-semibold text-gray-700">Your Plans</h2>
          <button id="refreshBtn" class="px-3 py-1 text-sm bg-gray-100 border rounded">Refresh</button>
        </div>
        <ul id="plansList" class="space-y-3"></ul>
      </div>
    </main>
  </div>

  <script>
    // API base
    const API = (window.ZENO_AUTH_CONFIG && window.ZENO_AUTH_CONFIG.API_BASE) || "http://localhost:8000";
    // token is optional — site can run without login

    function setStatus(ok) {
      const dot = document.getElementById("statusDot");
      if (dot) dot.className = "ml-2 inline-block w-2.5 h-2.5 rounded-full " + (ok ? "bg-green-500" : "bg-red-500");
    }

    async function ping() {
      try {
        const h = await fetch(`${API}/health`).then(r => r.json());
        const d = await fetch(`${API}/db-ping`).then(r => r.json());
        console.log("health:", h, "db:", d);
        setStatus(true);
      } catch (e) {
        console.error("Backend not reachable:", e);
        setStatus(false);
      }
    }

    async function api(path, opts = {}) {
      const headers = { "Content-Type": "application/json" };
      try {
        const token = localStorage.getItem('zeno_token');
        if (token) headers["Authorization"] = `Bearer ${token}`;
      } catch {}
      const res = await fetch(`${API}${path}`, { headers, ...opts });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${await res.text()}`);
      return res.json();
    }

    async function loadProfile() {
      try {
        const token = localStorage.getItem('zeno_token');
        if (!token) return; // don't attempt if not authenticated
        const me = await api('/auth/me');
        // expose current user for other functions
        window.currentUser = me;
        const profileEl = document.querySelector('aside div div p.font-semibold');
        if (profileEl) profileEl.textContent = me.username || me.email;
        const handleEl = document.querySelector('aside div div p.text-xs');
        if (handleEl) handleEl.textContent = '@' + (me.username || me.email.split('@')[0]);
      } catch (e) {
        console.warn('Failed to load profile:', e);
      }
    }

    // Load user's transcriptions and render summaries/topics
    async function loadTranscriptions() {
      const section = document.getElementById('transcriptionsSection');
      const list = document.getElementById('transcriptionsList');
      const msg = document.getElementById('transcriptionsMsg');
      if (!window.currentUser) {
        alert('Please sign in to view your uploads.');
        return;
      }
      section.classList.remove('hidden');
      list.innerHTML = '<div class="text-gray-500">Loading…</div>';
      msg.textContent = '';
      try {
        const resp = await api(`/api/ocr/user/${window.currentUser.id}/transcriptions`);
        const items = resp.transcriptions || resp.results || [];
        if (!items.length) {
          list.innerHTML = '<div class="text-gray-500">No uploads found.</div>';
          return;
        }
        list.innerHTML = '';
        for (const t of items) {
          const li = document.createElement('div');
          li.className = 'border rounded-xl p-4 bg-gray-50';
          const filename = t.file_info?.original_filename || t.filename || 'Unnamed file';
          const created = t.created_at || t.content?.created_at || '';
          const summary = t.content?.summary || '';
          const topics = t.content?.key_topics || [];

          li.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="font-semibold text-gray-800">${escapeHtml(filename)}</div>
                <div class="text-xs text-gray-500 mt-1">${escapeHtml(created)}</div>
                <div class="mt-3 text-sm text-gray-700">${summary ? escapeHtml(summary) : '<em>Summary pending…</em>'}</div>
                <ul class="list-disc list-inside mt-2 text-sm text-gray-600">${topics.length ? topics.map(x => `<li>${escapeHtml(x)}</li>`).join('') : ''}</ul>
              </div>
              <div class="ml-4 flex flex-col gap-2">
                <button class="px-3 py-1 rounded bg-blue-600 text-white text-sm" data-refresh="${escapeHtml(t.transcription_id || '')}">Refresh</button>
                <button class="px-3 py-1 rounded bg-gray-100 text-sm" data-open="${escapeHtml(t.transcription_id || '')}">Open</button>
              </div>
            </div>`;

          list.appendChild(li);
        }
      } catch (err) {
        list.innerHTML = '';
        msg.textContent = 'Error loading uploads: ' + err.message;
      }
    }

    // Refresh a single transcription by id (re-fetch list for simplicity)
    async function refreshTranscription(id) {
      // for now, reload entire list — could optimize to fetch single doc
      await loadTranscriptions();
    }

    // Hook buttons
    document.addEventListener('click', function(e) {
      const refreshId = e.target.getAttribute('data-refresh');
      const openId = e.target.getAttribute('data-open');
      if (refreshId) {
        refreshTranscription(refreshId);
      }
      if (openId) {
        // navigate to transcription detail page if you have one; fallback: alert
        alert('Open transcription: ' + openId);
      }
    });

    document.getElementById('viewUploadsBtn').addEventListener('click', () => loadTranscriptions());

    const planForm = document.getElementById("planForm");
    const planMsg = document.getElementById("planMsg");
    const plansList = document.getElementById("plansList");

    planForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      planMsg.textContent = "Saving…";
      try {
        const payload = {
          topic: document.getElementById("topic").value.trim(),
          notes: document.getElementById("notes").value || null,
        };
        await api("/plans", { method: "POST", body: JSON.stringify(payload) });
        planMsg.textContent = "Saved ✔";
        planForm.reset();
        loadPlans();
      } catch (err) {
        planMsg.textContent = "Error: " + err.message;
      }
    });

    async function loadPlans() {
      plansList.innerHTML = "<li class='text-gray-500'>Loading…</li>";
      try {
        const data = await api("/plans");
        if (!data.length) {
          plansList.innerHTML = "<li class='text-gray-500'>No plans yet.</li>";
          return;
        }
        plansList.innerHTML = "";
        for (const p of data) {
          const li = document.createElement("li");
          li.className = "border rounded-xl p-4 flex items-start justify-between";
          li.innerHTML = `
            <div>
              <div class="font-semibold text-gray-800">${escapeHtml(p.topic)}</div>
              <div class="text-sm text-gray-600">${escapeHtml(p.notes || "")}</div>
            </div>
            <div class="flex gap-2">
              <button class="text-sm px-3 py-1 rounded bg-gray-100 border" data-edit="${p.id}">Edit</button>
              <button class="text-sm px-3 py-1 rounded bg-red-600 text-white" data-del="${p.id}">Delete</button>
            </div>`;
          plansList.appendChild(li);
        }
      } catch (err) {
        plansList.innerHTML = `<li class='text-red-600 text-sm'>${err.message}</li>`;
      }
    }

    plansList.addEventListener("click", async (e) => {
      const idDel = e.target.getAttribute("data-del");
      const idEdit = e.target.getAttribute("data-edit");
      if (idDel) {
        if (!confirm("Delete this plan?")) return;
        await api(`/plans/${idDel}`, { method: "DELETE" });
        loadPlans();
      }
      if (idEdit) {
        const newNotes = prompt("Update notes:");
        if (newNotes != null) {
          await api(`/plans/${idEdit}`, { method: "PATCH", body: JSON.stringify({ notes: newNotes }) });
          loadPlans();
        }
      }
    });

    function escapeHtml(s) {
      return (s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    ping();
    loadProfile();
    loadPlans();
  </script>
</body>
</html>
